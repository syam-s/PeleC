

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using KGen &mdash; PeleC 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> PeleC
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Equations.html">Equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Algorithms.html">Numerical Treatment and Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BoundaryConditions.html">Boundary Conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geometry/EB.html">Geometry treatment in PeleC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LES.html">LES and Hybrid LES/DNS Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VandV.html">Correctness - Verification and Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PelePhysics.html">PelePhysics</a></li>
<li class="toctree-l1"><a class="reference internal" href="miscellaneous.html">Miscellaneous Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boxlib_bits.html">Development Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PeleC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Using KGen</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/miscellaneous/kgen.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-kgen">
<h1>Using KGen<a class="headerlink" href="#using-kgen" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://github.com/NCAR/KGen">KGen</a> is a tool developed by NCAR for extracting sections of Fortran code into a standalone program. This is useful for narrowing the scope of code involved in developing and porting computational kernels for new computer architectures or any other task that might benefit from this agility.</p>
<p>The way KGen works is by the developer first adding directives to the original source code files for whatever section or routine the they would like to extract. Next the developer can choose a set of invocations for the code section in which it will record input and output data to disk. Then by running KGen, it will modify the original code to capture the input and output variables (or “state”) for the code section, then build and run the full application and write the state data to disk. Next it will extract the kernel into a standalone program that is hardcoded to read its input from the state files. It uses this state data to both run and validate the resulting standalone kernel output against the original application output. It also measures the elasped time for each call to the kernel since typically the goal is to reduce runtime of the kernel.</p>
<p>To describe this process further, we give the following example where we will use KGen to extract the 3D diffterm Fortran kernel in PeleC. KGen generally requires Linux due to a dependency on the strace tool which doesn’t exist on other operating systems such as macOS. We will assume you have all the necessary repos for PeleC cloned in ${HOME}/combustion, for example PeleC cloned as ${HOME}/combustion/PeleC, etc.</p>
<p>We then perform the following steps:</p>
<ol class="arabic simple">
<li><p>Run something like the following commands: <cite>cd ${HOME} &amp;&amp; mkdir diffterm &amp;&amp; cd diffterm &amp;&amp; git clone https://github.com/NCAR/KGen.git &amp;&amp; mkdir diffterm_kernel</cite></p></li>
<li><p>Create a Makefile for KGen in ${HOME}/diffterm/diffterm_kernel/ which looks similar to this example:</p></li>
</ol>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span>KGEN_HOME := ${HOME}/diffterm/KGen
KGEN := ${KGEN_HOME}/bin/kgen
SRC_DIR := ${HOME}/combustion/PeleC/Source
EXEC_DIR := ${HOME}/combustion/PeleC/Exec/PMF
SRC := ${SRC_DIR}/Src_3d/diffterm_3d.f90

test:
    ${KGEN} \
            --cmd-clean &quot;cd ${EXEC_DIR}; make realclean&quot; \
            --cmd-build &quot;cd ${EXEC_DIR}; make -j8&quot; \
            --cmd-run &quot;cd ${EXEC_DIR}; ./PeleC3d.gnu.ex inputs-3d-regt&quot; \
            --invocation 0:0:1,0:0:2,0:0:3,0:0:4,0:0:5,0:0:6,0:0:7,0:0:119,0:0:120,0:0:121,0:0:346,0:0:347,0:0:348,0:0:349,0:0:350,0:0:697,0:0:698,0:0:699,0:0:700,0:0:701 \
            ${SRC}

clean:
    ${MAKE} clean -C src
    rm -rf kernel state kgen.log strace.log include.ini _kgen_compflag_cmdwrapper.sh model model.ini elapsedtime coverage papi
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Next we edit the <cite>${HOME}/combustion/PeleC/Source/Src_3d/diffterm_3d.f90</cite> file and add KGen directives around the kernel of interest which should look as such:</p></li>
</ol>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span>diff --git a/Source/Src_3d/diffterm_3d.f90 b/Source/Src_3d/diffterm_3d.f90
index e3a76c6..b29000b 100644
--- a/Source/Src_3d/diffterm_3d.f90
+++ b/Source/Src_3d/diffterm_3d.f90
@@ -120,6 +120,8 @@ contains
     double precision, parameter :: twoThirds = 2.d0/3.d0
     double precision :: dxinv(3)

<span class="m">+</span>    !$kgen begin_callsite diffterm
+
     dxinv = 1.d0/deltax

     call eos_ytx_vec(Q(lo(1)-1:hi(1)+1,lo(2)-1:hi(2)+1,lo(3)-1:hi(3)+1,QFS:QFS+nspecies-1),lo,hi,X,lo,hi,lo,hi,nspecies)
@@ -392,6 +394,7 @@ contains
           end do
        end do
     end do
<span class="m">+</span>    !$kgen end_callsite

   end subroutine pc_diffterm
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Now we should be able to just type the <cite>make</cite> command and KGen will instrument the original application, build the application, run the application to collect state data, and then extract the kernel into a <cite>kernel</cite> directory.</p></li>
<li><p>Note, for the diffterm kernel, there are calls to C routines which KGen is not able to account for so KGen will complain about missing symbols for the standalone kernel. To fix this, for our example we can copy the <cite>${HOME}/combustion/PelePhysics/Support/Fuego/Mechanism/Models/LiDryer/LiDryer.c</cite> and <cite>${HOME}/combustion/PelePhysics/Support/Fuego/Evaluation/ReactionData.H</cite> files from the PelePhysics repo into the <cite>kernel</cite> directory and include rules and the necessary dependencies for compiling into an object file and linking into the kernel executable. An example of the kernel makefile additions is listed below:</p></li>
</ol>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span>$ diff Makefile.orig Makefile
3a4
&gt; CC_0 := /nopt/nrel/apps/gcc/6.2.0/bin/gcc
4a6
&gt; C_FLAGS_SET_0 := -g -O3 -DBL_FORT_USE_UNDERSCORE
6c8
<span class="gh">&lt; ALL_OBJS := diffterm_3d.o eos.o AMReX_constants_mod.o AMReX_fort_mod.o meth_params.o actual_network.o prob_params.o kernel_driver.o kgen_utils.o tprof_mod.o</span>
<span class="gh">---</span>
&gt; ALL_OBJS := diffterm_3d.o eos.o AMReX_constants_mod.o AMReX_fort_mod.o meth_params.o actual_network.o prob_params.o kernel_driver.o kgen_utils.o tprof_mod.o LiDryer.o
17c19
<span class="gh">&lt; eos.o: eos.F90 kgen_utils.o tprof_mod.o AMReX_fort_mod.o AMReX_constants_mod.o</span>
<span class="gh">---</span>
&gt; eos.o: eos.F90 kgen_utils.o tprof_mod.o AMReX_fort_mod.o AMReX_constants_mod.o LiDryer.o
42a45,47
&gt;
&gt; LiDryer.o: LiDryer.c
&gt;   ${CC_0} ${C_FLAGS_SET_0} -I . -c -o $@ $&lt;
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>To run the kernel we <cite>cd</cite> to the kernel directory and type <cite>make</cite> which will build the kernel and run the kernel. Now we can refactor the kernel code and run it to validate the results see the effects on the runtime. When we are satisfied, it should be trivial to copy and paste the refactored kernel into the original application.</p></li>
</ol>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright AMReX Copyright (c) 2017, The Regents of the University of California, through Lawrence Berkeley National Laboratory and the Alliance for Sustainable Energy, LLC., through National Renewable Energy Laboratory (subject to receipt of any required approvals from the U.S. Dept. of Energy).  All rights reserved.

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>